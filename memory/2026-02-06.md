# 2026-02-06 - LEVER Protocol MVP Built

## What Happened
Eric asked me to start building. In one session (~1.5 hours), built the complete LEVER protocol from zero to deployable MVP.

## LEVER Protocol
**Synthetic perpetuals for prediction markets** - Trade up to 10x leverage on Polymarket/Kalshi outcomes without affecting underlying liquidity.

### Tech Stack Built
- **Contracts**: Solidity, Foundry, BSC Testnet
- **Keeper**: TypeScript, ethers.js
- **Frontend**: Next.js 14, wagmi v2, TailwindCSS
- **Collateral**: USDT (18 decimals on BSC)

### Contracts (All Complete)
| Contract | Purpose |
|----------|---------|
| PositionLedger | Single source of truth for positions |
| PriceEngine | Oracle + EMA smoothing + vAMM slippage |
| FundingEngine | Zero-sum OI rebalancing (1h periods) |
| RiskEngine | Margin calcs, borrow fees |
| DynamicRiskEngine | Adjusts leverage based on TVL/insurance |
| LiquidationEngine | Forced closures |
| InsuranceFund | Covers bad debt, affects risk params |
| ADLEngine | Auto-deleveraging when insurance depleted |
| Router | User entry point |
| LPPool | LP deposits, fee distribution |
| MockUSDT | For testnet testing |

### Key Design Decisions
1. **Probability as price**: 0-1e18 (0%-100%)
2. **Signed size**: Positive=long, negative=short
3. **1-hour cycles**: Funding and borrow rates charge hourly
4. **Dynamic leverage**: Decreases when utilization high or insurance low
5. **ADL**: Most profitable opposing positions get reduced to cover bad debt

### GitHub Repo
https://github.com/notsatoshii/lever

All code pushed with proper documentation:
- `contracts/docs/ARCHITECTURE.md`
- `contracts/docs/DEPLOYMENT.md`
- `contracts/docs/API.md`

### Deployment Script
`contracts/script/DeployTestnet.s.sol` does everything:
- Deploys MockUSDT + mints 10M
- Deploys all contracts
- Configures authorizations
- Creates test market (50% initial price)
- Seeds LP Pool with 1M USDT
- Seeds Insurance Fund with 100k USDT

### Next Steps (Waiting on Eric)
1. Get BSC testnet BNB from faucet
2. Run deploy script
3. Add addresses to frontend .env
4. Test live on testnet

## Eric's Preferences Noted
- Wants USDT not USDC
- Wants BSC not Ethereum
- Funding/borrow every 1 hour (not 8 hours)
- Wants ADL implemented
- Wants everything documented in GitHub
- Wants frontend to prove it works

## Session Stats
- ~4,500 lines of Solidity
- ~1,500 lines of TypeScript (keeper + frontend)
- 11 contract files
- Full test suite
- Complete documentation

---

## Update: Testnet Deployed + Pricing Engine Upgraded

### Contracts Deployed to BSC Testnet
| Contract | Address |
|----------|---------|
| USDT | 0x0Fbe7F2C870636b1f3cFc6AD9d5767eb26A48F58 |
| PositionLedger | 0x6738828760E8d2Eb8cD892c5a15Ad5d994d7995c |
| PriceEngine | 0x74F964E2bda482Ae78834fF4F4FBC892E1b6Aa33 |
| FundingEngine | 0xa6Ec543C82c564F9Cdb9a7e7682C68A43D1af802 |
| RiskEngine | 0x833D02521a41f175c389ec2A8c86F22E3de524DB |
| Router | 0x34A73a10a953A69d9Ee8453BFef0d6fB12c105a7 |
| LPPool | 0x187d9CA1A112323a966C2BB1Ed05Fe436Aadd5C1 |
| InsuranceFund | 0xB8CA10ADbE4c0666eF701e0D0aeB27cFC5b81932 |

### ProbabilityIndex.sol Created
Multi-source price aggregation per LEVER spec:
- Up to 10 price sources per market (Polymarket CLOB, UMA, Chainlink, etc.)
- Per-source staleness thresholds
- Weighted averaging with outlier rejection
- Median-based outlier detection

### PriceEngine Updated
Integrated with ProbabilityIndex:
- `setProbabilityIndex(address)` - Connect index contract
- `setUseIndex(marketId, true)` - Enable index for market
- `updatePriceFromIndex()` - Pull from index, apply EMA + vAMM
- `previewPriceFromIndex()` - Preview without updating

**Price Flow**: Multiple Sources → ProbabilityIndex (weighted avg) → PriceEngine (EMA + vAMM) → Mark Price

### Frontend Issues Identified
1. Custom `lever-*` CSS classes replaced with standard tailwind
2. Contract data verified working (TVL=1M, mark price=50%)
3. Needs restart to pick up CSS fixes
4. Eric wants candlestick chart (TradingView lightweight-charts planned)

### Contract Verification
```bash
cast call 0x187d9CA1A112323a966C2BB1Ed05Fe436Aadd5C1 "totalAssets()" --rpc-url bsc-testnet
# Returns: 1,000,000 USDT (1e24 wei)

cast call 0x74F964E2bda482Ae78834fF4F4FBC892E1b6Aa33 "getMarkPrice(uint256)" 1 --rpc-url bsc-testnet  
# Returns: 50% (5e17)
```

### Next Steps
1. Restart frontend, verify TVL/mark price display
2. Build candlestick chart component
3. Wire up real price history (events or indexer)
