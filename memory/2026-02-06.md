# Session Memory - 2026-02-06

## RouterV3 Deployed - Complete Fee Implementation
**Address:** `0x346D9eC78F8437c2aa32375584B959ccCDc843E1`

**Features implemented:**
- LP allocation/deallocation when positions open/close
- Trading fees (10 bps) - collected and sent to LP Pool
- Borrow fee charging from RiskEngine
- Funding payment settlement from FundingEngine

**Old routers deauthorized:**
- V1: `0x510Ba12a9B32b2032f1A7B5C483afc1255B7436e`
- V2: `0xd04469ADb9617E3efd830137Fd42FdbB43B6bDfa`

## Critical Bug Identified (FIXED)
**Router doesn't call `lpPool.allocate()`** when opening positions. Result:
- Positions open and track OI in Ledger
- But LP Pool shows 0% utilization
- Leverage is unfunded - no LP capital reserved for profits

## On-Chain State (as of ~12:46 UTC)
- Market 1: $2,000 Long OI (only position)
- Markets 2-3: Active but $0 OI
- Markets 4-5: Inactive
- LP Pool: $1M TVL, $0 allocated, 0% utilization

## Files Created This Session

### Contracts
- `/contracts/src/RouterV2.sol` - Fixed router with LP allocation
- `/contracts/script/DeployRouterV2.s.sol` - Deployment script
- `/contracts/script/AddMarketsV2.s.sol` - 5 new markets (4-8)

### Frontend
- `/frontend/src/config/markets.ts` - Market ID → Polymarket mapping
- Markets data inlined in page.tsx (import issue workaround)
- Fixed: useState initial value must be sync, not in useEffect

### Keeper
- `/keeper/polymarket-keeper.ts` - Syncs Polymarket → PriceEngine

## Deployment Needed (Requires Private Key)
1. Deploy RouterV2
2. Authorize RouterV2 on Ledger (`setEngineAuthorization`)
3. Authorize RouterV2 on LP Pool (`setAllocatorAuthorization`)
4. Run AddMarketsV2 for 5 new markets
5. Start polymarket-keeper

## Frontend Bug Fixes Applied
- Navigation: "Deposit" → "Connect Wallet"
- Navigation: Shows real USDT balance
- Portfolio: Real PnL calculation (not random)
- Portfolio: Fetches unclaimed fees from LP
- TradingPanel: Calculates liquidation price
- PriceChart: Uses Polymarket price as base
- Home: Markets render with on-chain prices

## Eric's Frustration Points
- Positions not all showing (only 1 of claimed 3)
- LP utilization at 0% despite open positions
- "Where is leverage coming from?" - Answer: Nowhere (bug)

## Next Steps
1. Get private key from Eric
2. Deploy RouterV2 + authorize
3. Deploy 5 new markets
4. Start keeper service
5. Verify LP allocation works on new positions
